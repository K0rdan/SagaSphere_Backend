version: "3"

services:
    sagasphere:
        container_name: sagasphere
        image: node:7-slim
        network_mode: "host"
        volumes:
            - ./sagasphere:/usr/src/sagasphere
        ports: 
            - "${SAGASPHERE_PORT}:${SAGASPHERE_PORT}"
        command: ["bash","-c","cd /usr/src/sagasphere && npm run build && npm run start"]
    sagasphere_mysql:
        container_name: sagasphere_mysql
        image: mysql:latest
        volumes: 
            # Default MySQL data volume
            - /var/lib/mysql
            # Init database with our SQL file
            - ./sagasphere_mysql/database-${SAGASPHERE_ENV}.sql:/docker-entrypoint-initdb.d/database-${SAGASPHERE_ENV}.sql
        expose:
            # Default MySQL listening port 
            - "${SAGASPHERE_MYSQL_PORT}"
        environment:
            # Environment variables preceed by SAGASPHERE_MYSQL_
            - MYSQL_ROOT_PASSWORD=${SAGASPHERE_MYSQL_PASSWORD}
            - MYSQL_DATABASE=${SAGASPHERE_MYSQL_DATABASE}
    sagasphere_phpmyadmin:
        container_name: sagasphere_phpmyadmin
        image: phpmyadmin/phpmyadmin:latest
        volumes:
            # Login sessions to MySQL
            - /sessions
        ports:
            - "${SAGASPHERE_PMA_PORT}:80"
        environment:
            # Environment variables preceed by PMA_
            - PMA_HOST=${SAGASPHERE_PMA_HOST}
        links:
            - sagasphere_mysql
    redis:
        container_name: sagasphere_sessions
        image: redis:alpine
        ports:
            - "${SAGASPHERE_REDIS_PORT}:${SAGASPHERE_REDIS_PORT}"
        environment:
            # Environment variables preceed by REDIS_
            - REDIS_PORT=${SAGASPHERE_REDIS_PORT}